<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AVAIL">
    <title>AVAIL â€” Opportunity Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css?v={{ app_version }}">
</head>
<body>
{% if not logged_in %}
<div class="login">
    <div class="login-card">
        <img src="/static/avail_logo.png" alt="AVAIL" class="login-logo">
        <div class="login-divider"></div>
        <p class="sub">Trio Supply Chain Solutions</p>
        <a href="/auth/login" class="btn-ms">
            <svg width="18" height="18" viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#f25022"/><rect x="11" y="1" width="9" height="9" fill="#7fba00"/><rect x="1" y="11" width="9" height="9" fill="#00a4ef"/><rect x="11" y="11" width="9" height="9" fill="#ffb900"/></svg>
            Sign in with Microsoft
        </a>
        <p class="ver">v{{ app_version }}</p>
    </div>
</div>
{% else %}
<a href="#view-list" class="skip-link" onclick="document.getElementById('mainSearch').focus();return false;">Skip to content</a>
<!-- TOP AREA â€” logo on grey bg + controls inline to the right -->
<div class="toparea">
    <img src="/static/avail_logo.png" alt="AVAIL" onclick="sidebarNav('reqs',document.getElementById('navReqs'))" style="cursor:pointer" title="Back to RFQs">
    <div class="topcontrols" id="topcontrols">
        <div class="fpills" id="mainPills">
            <button type="button" class="fp on" data-view="rfq" onclick="setMainView('rfq',this)">RFQ</button>
            <button type="button" class="fp" data-view="sourcing" onclick="setMainView('sourcing',this)">Sourcing</button>
            <button type="button" class="fp" data-view="archive" onclick="setMainView('archive',this)">Archive</button>
        </div>
        <a class="bug-link" onclick="openModal('bugReportModal')">Report a Bug</a>
        <div class="search-wrap">
            <input type="text" class="sbox" id="mainSearch" placeholder="&#x1f50d;  Search customer, part, RFQ&hellip;" aria-label="Search requisitions" oninput="debouncedMainSearch(this.value)" onkeydown="if(event.key==='Enter')triggerMainSearch()">
            <button type="button" class="search-btn" id="mainSearchBtn" onclick="triggerMainSearch()" title="Search"><svg class="search-icon" viewBox="0 0 20 20" fill="none"><circle cx="8.5" cy="8.5" r="5.5" stroke="currentColor" stroke-width="2"/><line x1="12.5" y1="12.5" x2="17" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><svg class="spinner-icon" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="10" stroke-linecap="round"/></svg></button>
            <kbd class="search-hint">/</kbd>
        </div>
        <div class="fpills fpills-sm" id="statusToggle" style="display:none">
            <button type="button" class="fp fp-sm" data-sf="draft" onclick="setStatusFilter('draft',this)">Draft</button>
            <button type="button" class="fp fp-sm on" data-sf="active" onclick="setStatusFilter('active',this)">Sourcing</button>
        </div>
        <div class="tb-group">
            <button type="button" class="tb-action tb-accent-orange" id="myAccountsBtn" onclick="toggleMyAccounts(this)">My Accounts</button>
            <div class="toolbar-stats" id="toolbarStats"></div>
            <span class="tb-sep"></span>
            <button type="button" class="tb-action tb-primary" onclick="openNewReqModal()">+ New RFQ</button>
            <div class="filter-wrap">
                <button type="button" class="tb-action" onclick="toggleNotifications()" title="Notifications">
                    <svg class="notif-bell" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                    <span id="notifBadge" class="notif-badge">0</span>
                </button>
                <div id="notifPanel" class="filter-panel">
                    <div style="font-weight:700;font-size:13px;margin-bottom:8px">Notifications</div>
                    <div id="notifList"><p class="empty" style="font-size:12px">No notifications</p></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar rail â€” blue strip with chevron, click to toggle -->
<div class="sb-rail" onclick="toggleSidebar()" title="Toggle menu" aria-label="Toggle sidebar">
    <svg viewBox="0 0 10 14"><polyline points="2,2 8,7 2,12"/></svg>
</div>

<!-- Mobile top bar -->
<div class="mobile-topbar">
    <button type="button" class="hamburger" onclick="toggleMobileSidebar()">&#9776;</button>
    <img src="/static/avail_logo.png" alt="AVAIL" class="mobile-logo" onclick="sidebarNav('reqs',document.getElementById('navReqs'))" style="cursor:pointer">
    <div class="search-wrap mobile-search-wrap">
        <input type="text" class="sbox mobile-search" id="mobileMainSearch"
               placeholder="&#x1f50d; Searchâ€¦" aria-label="Search requisitions" oninput="debouncedMainSearch(this.value)" onkeydown="if(event.key==='Enter')triggerMainSearch()">
        <button type="button" class="search-btn" id="mobileSearchBtn" onclick="triggerMainSearch()" title="Search"><svg class="search-icon" viewBox="0 0 20 20" fill="none"><circle cx="8.5" cy="8.5" r="5.5" stroke="currentColor" stroke-width="2"/><line x1="12.5" y1="12.5" x2="17" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><svg class="spinner-icon" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="2" stroke-dasharray="32" stroke-dashoffset="10" stroke-linecap="round"/></svg></button>
    </div>
    <button type="button" class="mobile-notif-btn" onclick="toggleNotifications()" title="Notifications">
        &#x1f514;<span id="mobileNotifBadge" class="filter-badge" style="position:absolute;top:-4px;right:-4px;background:var(--red);display:none">0</span>
    </button>
</div>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleMobileSidebar()"></div>

<!-- SIDEBAR â€” v7 slide-out -->
<aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <nav class="sidebar-nav">
        <button type="button" class="active" id="navReqs" onclick="sidebarNav('reqs',this)"><span class="ni">&#x1f4cb;</span> RFQs</button>
        <button type="button" id="navCustomers" onclick="sidebarNav('customers',this)"><span class="ni">&#x1f3e2;</span> Customers</button>
        <button type="button" id="navVendors" onclick="sidebarNav('vendors',this)"><span class="ni">&#x1f91d;</span> Vendors</button>
        <button type="button" id="navMaterials" onclick="sidebarNav('materials',this)"><span class="ni">&#x1f527;</span> Materials</button>
        <button type="button" id="navBuyPlans" onclick="sidebarNav('buyplans',this)"><span class="ni">&#x1f4e6;</span> Buy Plans</button>
        <button type="button" id="navScorecards" onclick="sidebarNav('performance',this)"><span class="ni">&#x1f4ca;</span> Scorecards</button>
        <button type="button" id="navProactive" onclick="sidebarNav('proactive',this)" style="display:none"><span class="ni">&#x2b50;</span> Proactive</button>
        <button type="button" id="navSettings" onclick="sidebarNav('settings',this)" style="display:none"><span class="ni">&#x2699;</span> Settings</button>
        <button type="button" class="nav-logout" onclick="fetch('/auth/logout',{method:'POST'}).then(()=>location.reload())"><span class="ni">&#x1f6aa;</span> Logout</button>
    </nav>
    <div class="sidebar-footer">
        <span class="ui">{{ user_name[:2]|upper if user_name else 'U' }}</span>
        <span class="un">{{ user_name }}</span>
        <span id="roleBadge" style="display:none"></span>
        {% if is_admin %}<span class="rb">Admin</span>{% endif %}
        <span id="m365Status" style="display:none;font-size:10px;padding:4px 8px"><span id="m365Dot"></span><span id="m365Label"></span></span>
    </div>
</aside>

<!-- Main content -->
<main class="main">
    <div class="main-scroll">

    <!-- VIEW: Requisition List (v7 â€” header/tabs/filters are in toparea) -->
    <div id="view-list">
        <!-- followUpsPanel removed per user request -->
        <div id="reqList" aria-live="polite"><p class="empty">Loadingâ€¦</p></div>
    </div>

    <!-- VIEW: Requisition Detail (removed â€” drill-down sub-tabs replaced this) -->
    <div id="view-detail" style="display:none"></div>

    <!-- Log Offer Modal -->
    <div id="logOfferModal" class="modal-bg" onclick="if(event.target===this)closeLogOfferModal()">
        <div class="modal" style="max-width:520px" onclick="event.stopPropagation()">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h3 style="margin:0;font-size:14px">Log Confirmed Offer</h3>
                <button class="btn btn-ghost btn-sm" onclick="closeLogOfferModal()" style="font-size:16px;padding:0 6px">&times;</button>
            </div>
            <form id="logOfferForm" onsubmit="event.preventDefault();submitLogOffer()">
                <input type="hidden" id="loReqId">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                    <div style="grid-column:1/-1">
                        <label style="font-size:11px;color:var(--muted)">Part *</label>
                        <select id="loReqPart" style="width:100%" required><option value="">Select part...</option></select>
                    </div>
                    <div style="grid-column:1/-1">
                        <label style="font-size:11px;color:var(--muted)">Vendor Name *</label>
                        <input id="loVendor" required placeholder="e.g. Arrow Electronics" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Qty Available</label>
                        <input id="loQty" type="number" min="0" placeholder="0" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Unit Price ($)</label>
                        <input id="loPrice" type="number" step="0.0001" min="0" placeholder="0.00" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Lead Time</label>
                        <input id="loLead" placeholder="e.g. 2-3 weeks" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">MOQ</label>
                        <input id="loMoq" type="number" min="0" placeholder="0" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Condition</label>
                        <select id="loCond" style="width:100%">
                            <option value="new">New</option>
                            <option value="refurbished">Refurbished</option>
                            <option value="used">Used</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Date Code</label>
                        <input id="loDc" placeholder="e.g. 2024+" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Packaging</label>
                        <input id="loPkg" placeholder="e.g. Tray, Reel" style="width:100%">
                    </div>
                    <div>
                        <label style="font-size:11px;color:var(--muted)">Manufacturer</label>
                        <input id="loMfr" placeholder="e.g. Texas Instruments" style="width:100%">
                    </div>
                    <div style="grid-column:1/-1">
                        <label style="font-size:11px;color:var(--muted)">Notes</label>
                        <textarea id="loNotes" rows="2" placeholder="Additional details..." style="width:100%;resize:vertical"></textarea>
                    </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="closeLogOfferModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm" id="loSubmitBtn">Log Offer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- VIEW: Customers -->
    <div id="view-customers" style="display:none">
        <div class="view-toolbar">
            <h2>Customers</h2>
            <input class="sbox sbox-wide" id="custFilter" placeholder="Search companiesâ€¦" oninput="debouncedLoadCustomers()" aria-label="Search companies">
            <div class="fpills fpills-sm">
                <button type="button" class="fp fp-sm" id="custUnassignedPill" onclick="toggleCustUnassigned(this)">Unassigned</button>
            </div>
            <label id="custMyOnlyLabel" class="tb-btn" style="display:none;gap:4px;cursor:pointer;align-items:center">
                <input type="checkbox" id="custMyOnly" onchange="loadCustomers()" class="u-accent-teal" aria-label="Show only my accounts"> My accounts
            </label>
            <button type="button" class="btn btn-primary btn-sm" onclick="openNewCompanyModal()">+ New Company</button>
            <span id="custFilterCount" class="text-muted u-fs-xs"></span>
        </div>
        <div id="custList" aria-live="polite"><p class="empty">Loadingâ€¦</p></div>
    </div>

    <!-- VIEW: Vendors -->
    <div id="view-vendors" style="display:none">
        <div class="view-toolbar">
            <h2>Vendor Directory</h2>
            <div class="fpills" id="vendorTierPills">
                <button type="button" class="fp on" onclick="setVendorTier('all',this)">All</button>
                <button type="button" class="fp" onclick="setVendorTier('proven',this)">Proven</button>
                <button type="button" class="fp" onclick="setVendorTier('developing',this)">Developing</button>
                <button type="button" class="fp" onclick="setVendorTier('caution',this)">Caution</button>
                <button type="button" class="fp" onclick="setVendorTier('new',this)">New</button>
            </div>
            <input class="sbox sbox-med" id="vendorSearch" placeholder="Search vendorsâ€¦" oninput="debouncedFilterVendors()" aria-label="Search vendors">
            <label class="tb-btn" style="display:flex;align-items:center;gap:4px;cursor:pointer">
                <input type="checkbox" id="vendorHideBL" onchange="filterVendorList()" aria-label="Hide blacklisted" class="u-accent-teal"> Hide blacklisted
            </label>
            <span id="vendorFilterCount" class="text-muted"></span>
        </div>
        <div id="vendorList" aria-live="polite"><p class="empty">Loadingâ€¦</p></div>
    </div>

    <!-- VIEW: Materials -->
    <div id="view-materials" style="display:none">
        <div class="view-toolbar">
            <h2>Materials</h2>
            <input class="sbox sbox-wide" id="materialSearch" placeholder="Search by MPN or manufacturerâ€¦" oninput="debouncedLoadMaterials()" aria-label="Search material cards">
            <button type="button" class="tb-btn" onclick="toggleStockImport()">Import Stock</button>
        </div>
        <div id="stockImportArea" data-role="buyer" style="display:none;margin-bottom:12px" class="card">
            <strong style="font-size:12px;color:var(--muted)">Import a vendor stock list â€” all rows stored as material cards with vendor history</strong>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap">
                <div class="site-typeahead" style="flex:1;min-width:150px"><input id="stockVendorName" placeholder="Vendor name (required)â€¦" required aria-label="Vendor name for stock import" autocomplete="off" style="width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text)"><div class="site-typeahead-list" id="stockVendorNameList"></div></div>
                <input id="stockVendorWebsite" placeholder="Website (for new vendor)" aria-label="Vendor website URL" class="ac-website-inline" style="display:none;flex:0 0 180px;padding:6px 10px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-size:12px">
                <input type="file" id="stockFileInput" accept=".csv,.xlsx,.xls,.tsv" style="display:none" onchange="showFileReady('stockFileInput','stockFileReady','stockFileName')">
                <button type="button" class="btn btn-ghost btn-sm" onclick="document.getElementById('stockFileInput').click()">Choose File</button>
            </div>
            <div id="stockFileReady" style="display:none;margin-top:8px">
                <div style="display:flex;gap:8px;align-items:center">
                    <span style="font-size:12px;color:var(--text2)">ðŸ“„ <span id="stockFileName"></span></span>
                    <button type="button" class="btn btn-primary btn-sm" onclick="doStockImport()">Import</button>
                    <button type="button" class="btn btn-ghost btn-sm" onclick="clearFileInput('stockFileInput','stockFileReady')">Cancel</button>
                </div>
            </div>
            <div class="uzone-hint" style="margin-top:4px">CSV/XLSX â€” columns: mpn (or part_number), qty, price, manufacturer</div>
            <div id="stockImportStatus" class="ustatus"></div>
        </div>
        <div id="materialList"><p class="empty">Loadingâ€¦</p></div>
    </div>

    <!-- VIEW: Buy Plans (admin only) -->
    <div id="view-buyplans" style="display:none">
        <div class="view-toolbar">
            <h2>Buy Plans</h2>
            <div class="fpills" id="bpStatusPills">
                <button type="button" class="fp on" data-bp-status="" onclick="setBpFilter('',this)">All</button>
                <button type="button" class="fp" data-bp-status="pending_approval" onclick="setBpFilter('pending_approval',this)">Pending</button>
                <button type="button" class="fp" data-bp-status="approved" onclick="setBpFilter('approved',this)">Approved</button>
                <button type="button" class="fp" data-bp-status="po_entered" onclick="setBpFilter('po_entered',this)">PO Entered</button>
                <button type="button" class="fp" data-bp-status="po_confirmed" onclick="setBpFilter('po_confirmed',this)">Confirmed</button>
                <button type="button" class="fp" data-bp-status="complete" onclick="setBpFilter('complete',this)">Complete</button>
                <button type="button" class="fp" data-bp-status="cancelled" onclick="setBpFilter('cancelled',this)">Cancelled</button>
            </div>
            <input class="sbox sbox-med" id="bpSearch" placeholder="Search buy plansâ€¦" aria-label="Search buy plans" oninput="renderBuyPlansList()">
        </div>
        <div id="buyPlansList"><p class="empty">Loadingâ€¦</p></div>
    </div>

    <!-- VIEW: Proactive Offers -->
    <div id="view-proactive" style="display:none">
        <div class="vendor-header">
            <h2>Proactive Offers</h2>
        </div>
        <div class="tabs" id="proactiveTabs">
            <button type="button" class="tab on" onclick="switchProactiveTab('matches',this)">Matches</button>
            <button type="button" class="tab" onclick="switchProactiveTab('sent',this)">Sent</button>
            <button type="button" class="tab" onclick="switchProactiveTab('scorecard',this)">Scorecard</button>
        </div>
        <div id="proactiveMatchesPanel"><p class="empty">Loadingâ€¦</p></div>
        <div id="proactiveSentPanel" style="display:none"><p class="empty">Loadingâ€¦</p></div>
        <div id="proactiveScorecardPanel" style="display:none"><p class="empty">Loadingâ€¦</p></div>
    </div>

<!-- New Requisition Modal -->
<div id="newReqModal" class="modal-bg" onclick="if(event.target===this)closeModal('newReqModal')">
    <div class="modal">
        <h2>New Requisition</h2>
        <div class="field"><label for="nrName">Name <span style="color:var(--red)">*</span></label><input id="nrName" placeholder="e.g. Siemens Medical - Feb 2026" onkeydown="if(event.key==='Enter')createRequisition()" required></div>
        <div class="field" style="margin-top:10px">
            <label>Customer Account <span style="color:var(--red)">*</span></label>
            <div class="site-typeahead">
                <input id="nrSiteSearch" placeholder="Type to search companiesâ€¦" oninput="debouncedFilterSites(this.value)" onfocus="filterSiteTypeahead(this.value)" autocomplete="off" aria-label="Search customer sites">
                <input type="hidden" id="nrSiteId">
                <div class="site-typeahead-list" id="nrSiteList"></div>
            </div>
            <div id="nrSiteSelected" style="display:none;margin-top:6px;padding:8px 12px;background:var(--teal-light);border:1px solid rgba(61,104,149,.15);border-radius:6px;font-size:12px">
                <span id="nrSiteSelectedLabel" class="u-fw-600"></span>
                <span onclick="clearNrSite()" style="margin-left:8px;color:var(--red);cursor:pointer;font-size:11px">Clear</span>
            </div>
        </div>
        <div class="field" style="margin-top:10px">
            <label>Bid Due</label>
            <div class="u-flex u-items-center u-gap-md">
                <input type="date" id="nrDeadline" style="flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--white);color:var(--text)">
                <label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer;white-space:nowrap"><input type="checkbox" id="nrAsap" onchange="if(this.checked)document.getElementById('nrDeadline').value=''"> ASAP</label>
            </div>
        </div>
        <div class="field" id="nrContactField" style="margin-top:10px;display:none">
            <label>Requesting Contact</label>
            <select id="nrContactSelect" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--white);color:var(--text)">
                <option value="">â€” Select contact â€”</option>
            </select>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('newReqModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="createRequisition()">Create</button>
        </div>
    </div>
</div>

<!-- Batch RFQ Modal -->
<div id="rfqModal" class="modal-bg" onclick="if(event.target===this&&!this.dataset.loading)closeModal('rfqModal')">
    <div class="modal modal-lg">
        <h2>Send Batch RFQ</h2>
        <div id="rfqPrepare">
            <div class="u-flex u-items-center u-gap-md u-mb-md">
                <div class="spinner"></div>
                <p id="rfqPrepareStatus" style="font-size:12px;color:var(--text2);margin:0">Checking vendor contactsâ€¦</p>
            </div>
            <div id="rfqPrepareVendors" style="max-height:240px;overflow-y:auto;margin-bottom:12px"></div>
            <button type="button" class="btn btn-ghost btn-sm" onclick="delete document.getElementById('rfqModal').dataset.loading;closeModal('rfqModal')">Cancel</button>
        </div>
        <div id="rfqReady" style="display:none">
            <p style="font-size:12px;color:var(--text2);margin-bottom:10px" id="rfqSummary"></p>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button type="button" class="btn btn-ghost btn-sm" onclick="rfqSelectAllVendors()">Select All</button>
                <button type="button" class="btn btn-ghost btn-sm" onclick="rfqDeselectAllVendors()">Deselect All</button>
            </div>
            <div id="rfqVendorList" style="max-height:240px;overflow-y:auto;margin-bottom:12px"></div>
            <div class="rfq-condition">
                <label>Condition Required</label>
                <button type="button" class="rfq-cond-btn active" onclick="setRfqCondition('any',this)">Any</button>
                <button type="button" class="rfq-cond-btn" onclick="setRfqCondition('new',this)">New</button>
                <button type="button" class="rfq-cond-btn" onclick="setRfqCondition('used',this)">Used</button>
            </div>
            <div class="field"><label>Subject</label><input id="rfqSubject" aria-label="RFQ email subject"></div>
            <div class="field">
                <label>Message</label>
                <textarea id="rfqBody" style="min-height:160px"></textarea>
            </div>
            <div class="mactions">
                <button type="button" class="btn btn-ghost" onclick="closeModal('rfqModal')">Cancel</button>
                <button type="button" class="btn btn-success" id="rfqSendBtn" onclick="sendBatchRfq()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Vendor Card Popup -->
<div id="vendorPopup" class="modal-bg" onclick="if(event.target===this)closeModal('vendorPopup')">
    <div class="modal modal-lg">
        <div id="vendorPopupContent"><p class="empty">Loadingâ€¦</p></div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('vendorPopup')">Close</button>
        </div>
    </div>
</div>

<!-- Vendor Contact Modal -->
<div id="vendorContactModal" class="modal-bg" onclick="if(event.target===this)closeModal('vendorContactModal')">
    <div class="modal">
        <h2 id="vendorContactModalTitle">Add Vendor Contact</h2>
        <input type="hidden" id="vcCardId">
        <input type="hidden" id="vcContactId">
        <div class="lo-form">
            <div class="field"><label for="vcEmail">Email *</label><input id="vcEmail" type="email" placeholder="email@vendor.com" required onkeydown="if(event.key==='Enter')saveVendorContact()"></div>
            <div class="field"><label for="vcFullName">Name</label><input id="vcFullName" placeholder="Full name"></div>
            <div class="field"><label for="vcTitle">Job Title</label><input id="vcTitle" placeholder="e.g. Sales Manager"></div>
            <div class="field"><label for="vcPhone">Phone</label><input id="vcPhone" type="tel" placeholder="+1 555-000-0000"></div>
            <div class="field"><label for="vcLabel">Label</label><input id="vcLabel" placeholder="Sales, Support, etc." value="Sales"></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('vendorContactModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveVendorContact()">Save Contact</button>
        </div>
    </div>
</div>

<!-- Vendor Log Call Modal -->
<div id="vendorLogCallModal" class="modal-bg" onclick="if(event.target===this)closeModal('vendorLogCallModal')">
    <div class="modal">
        <h2>Log Vendor Call &mdash; <span id="vlcVendorName"></span></h2>
        <input type="hidden" id="vlcCardId">
        <div class="lo-form">
            <div class="field"><label for="vlcPhone">Phone</label><input id="vlcPhone" type="tel" placeholder="+1 555-000-0000" onkeydown="if(event.key==='Enter')saveVendorLogCall()"></div>
            <div class="field"><label for="vlcContactName">Contact Name</label><input id="vlcContactName" placeholder="Who did you speak to?"></div>
            <div class="field"><label for="vlcDirection">Direction</label>
                <select id="vlcDirection" style="background:var(--input);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;width:100%">
                    <option value="outbound">Outbound</option>
                    <option value="inbound">Inbound</option>
                </select>
            </div>
            <div class="field"><label for="vlcDuration">Duration (seconds)</label><input id="vlcDuration" type="number" placeholder="120" min="0"></div>
            <div class="field"><label for="vlcNotes">Notes</label><textarea id="vlcNotes" rows="3" placeholder="Call summary..." style="width:100%;background:var(--input);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;resize:vertical"></textarea></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('vendorLogCallModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveVendorLogCall()">Log Call</button>
        </div>
    </div>
</div>

<!-- Vendor Log Note Modal -->
<div id="vendorLogNoteModal" class="modal-bg" onclick="if(event.target===this)closeModal('vendorLogNoteModal')">
    <div class="modal">
        <h2>Add Note &mdash; <span id="vlnVendorName"></span></h2>
        <input type="hidden" id="vlnCardId">
        <div class="lo-form">
            <div class="field"><label for="vlnContactName">Contact Name (optional)</label><input id="vlnContactName" placeholder="Related contact name"></div>
            <div class="field"><label for="vlnNotes">Note *</label><textarea id="vlnNotes" rows="4" placeholder="Enter note..." required style="width:100%;background:var(--input);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;resize:vertical"></textarea></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('vendorLogNoteModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveVendorLogNote()">Save Note</button>
        </div>
    </div>
</div>

<!-- Material Card Popup -->
<div id="materialPopup" class="modal-bg" onclick="if(event.target===this)closeModal('materialPopup')">
    <div class="modal modal-lg">
        <div id="materialPopupContent"><p class="empty">Loadingâ€¦</p></div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('materialPopup')">Close</button>
        </div>
    </div>
</div>

<!-- New Company Modal -->
<div id="newCompanyModal" class="modal-bg" onclick="if(event.target===this)closeModal('newCompanyModal')">
    <div class="modal">
        <h2>New Company</h2>
        <div class="field"><label for="ncName">Company Name</label><div class="site-typeahead"><input id="ncName" placeholder="e.g. Siemens" required autocomplete="off" oninput="debouncedCheckDupCompany(this.value)" onkeydown="if(event.key==='Enter'&&!document.getElementById('ncNameList').classList.contains('show'))createCompany()"><div class="site-typeahead-list" id="ncNameList"></div></div><div id="ncDupWarning" style="display:none;margin-top:4px;padding:6px 10px;background:var(--amber-light,#fff8e1);border:1px solid var(--amber,#f59e0b);border-radius:6px;font-size:11px;color:var(--text)"></div></div>
        <div class="field"><label for="ncWebsite">Website</label><input id="ncWebsite" placeholder="siemens.com" type="url"></div>
        <div class="field"><label for="ncLinkedin">LinkedIn</label><input id="ncLinkedin" placeholder="linkedin.com/company/..." type="url"></div>
        <div class="field"><label for="ncIndustry">Industry</label><input id="ncIndustry" placeholder="Medical, Industrial, etc."></div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('newCompanyModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="createCompany()">Create &amp; Add Site</button>
        </div>
    </div>
</div>

<!-- Edit Company Modal -->
<div id="editCompanyModal" class="modal-bg" onclick="if(event.target===this)closeModal('editCompanyModal')">
    <div class="modal" style="max-width:560px">
        <input type="hidden" id="ecId">
        <h2>Edit Company</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div class="field" style="grid-column:1/-1"><label>Company Name</label><input id="ecName"></div>
            <div class="field"><label>Account Type</label>
                <select id="ecAccountType" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:12px">
                    <option value="">â€”</option>
                    <option>Customer</option><option>Prospect</option><option>Partner</option><option>Competitor</option>
                </select>
            </div>
            <div class="field"><label>Account Owner</label><select id="ecOwner" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:12px"></select></div>
            <div class="field"><label>Phone</label><input id="ecPhone" placeholder="+1 (555) 000-0000"></div>
            <div class="field"><label>Website</label><input id="ecWebsite" placeholder="company.com"></div>
            <div class="field"><label>Domain</label><input id="ecDomain" placeholder="company.com"></div>
            <div class="field"><label>LinkedIn</label><input id="ecLinkedin" placeholder="linkedin.com/company/..."></div>
            <div class="field"><label>Industry</label><input id="ecIndustry"></div>
            <div class="field"><label>Legal Name</label><input id="ecLegalName"></div>
            <div class="field"><label>Employee Size</label><input id="ecEmployeeSize" placeholder="51-200"></div>
            <div class="field"><label>HQ City</label><input id="ecHqCity"></div>
            <div class="field"><label>HQ State</label><input id="ecHqState"></div>
            <div class="field"><label>HQ Country</label><input id="ecHqCountry"></div>
            <div class="field"><label>Credit Terms</label><input id="ecCreditTerms" placeholder="Net 30"></div>
            <div class="field"><label>Tax ID</label><input id="ecTaxId" placeholder="EIN / VAT"></div>
            <div class="field"><label>Currency</label><input id="ecCurrency" placeholder="USD" style="width:80px"></div>
            <div class="field"><label>Preferred Carrier</label><input id="ecCarrier" placeholder="FedEx, UPS..."></div>
            <div class="field" style="grid-column:1/-1"><label>Notes</label><textarea id="ecNotes" rows="2" style="width:100%"></textarea></div>
            <div class="field"><label class="u-flex u-items-center u-gap-sm"><input type="checkbox" id="ecStrategic"> Strategic Account</label></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('editCompanyModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveEditCompany()">Save</button>
        </div>
    </div>
</div>

<!-- Add Site Modal -->
<div id="addSiteModal" class="modal-bg" onclick="if(event.target===this)closeModal('addSiteModal')">
    <div class="modal">
        <input type="hidden" id="asSiteCompanyId">
        <h2>Add Site to <span id="asSiteCompanyName"></span></h2>
        <div class="lo-form">
            <div class="field"><label for="asSiteName">Site Name</label><input id="asSiteName" placeholder="HQ, West Coast, etc." required></div>
            <div class="field"><label for="asSiteOwner">Owner</label><select id="asSiteOwner"><option value="">â€” None â€”</option></select></div>
            <div class="field"><label for="asSiteAddr1">Address Line 1</label><input id="asSiteAddr1" placeholder="123 Main St"></div>
            <div class="field"><label for="asSiteAddr2">Address Line 2</label><input id="asSiteAddr2" placeholder="Suite 200"></div>
            <div style="display:flex;gap:8px">
                <div class="field" style="flex:2"><label for="asSiteCity">City</label><input id="asSiteCity" placeholder="Austin"></div>
                <div class="field u-flex-1"><label for="asSiteState">State</label><input id="asSiteState" placeholder="TX"></div>
                <div class="field u-flex-1"><label for="asSiteZip">Zip</label><input id="asSiteZip" placeholder="78701"></div>
            </div>
            <div class="field"><label for="asSiteCountry">Country</label><input id="asSiteCountry" placeholder="US" value="US"></div>
            <div class="field"><label for="asSitePayTerms">Payment Terms</label><input id="asSitePayTerms" placeholder="Net 30"></div>
            <div class="field"><label for="asSiteShipTerms">Shipping Terms</label><input id="asSiteShipTerms" placeholder="FOB Origin"></div>
            <div class="field"><label for="asSiteType">Site Type</label>
                <select id="asSiteType" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:12px">
                    <option value="">â€”</option>
                    <option>HQ</option><option>Branch</option><option>Warehouse</option><option>Manufacturing</option>
                </select>
            </div>
            <div class="field"><label for="asSiteTimezone">Timezone</label><input id="asSiteTimezone" placeholder="America/New_York"></div>
            <div class="field"><label for="asSiteRecvHours">Receiving Hours</label><input id="asSiteRecvHours" placeholder="Mon-Fri 8am-5pm"></div>
            <div class="field"><label for="asSiteCarrierAcct">Carrier Account</label><input id="asSiteCarrierAcct" placeholder="UPS/FedEx acct #"></div>
            <div class="field"><label for="asSiteNotes">Notes</label><textarea id="asSiteNotes" rows="2" placeholder="Internal notes..." style="width:100%;resize:vertical"></textarea></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('addSiteModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="addSite()">Add Site</button>
        </div>
    </div>
</div>

<!-- Suggested Contacts Modal -->
<div id="suggestedContactsModal" class="modal-bg" onclick="if(event.target===this)closeModal('suggestedContactsModal')">
    <div class="modal modal-lg">
        <h2 id="scModalTitle">Suggested Contacts</h2>
        <p class="u-fs-xs u-color-muted u-mb-md" id="scModalSubtitle">Select contacts to add</p>
        <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center">
            <input class="req-search u-flex-1" id="scTitleFilter" placeholder="Filter by title (e.g. Sales, Procurement)â€¦"
                   onkeydown="if(event.key==='Enter')searchSuggestedContacts()">
            <button type="button" class="btn btn-ghost btn-sm" onclick="searchSuggestedContacts()">Search</button>
        </div>
        <div id="scResults" style="max-height:340px;overflow-y:auto;margin-bottom:12px">
            <p class="empty">Click Search or enter a title filter to find contacts</p>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('suggestedContactsModal')">Cancel</button>
            <button type="button" class="btn btn-primary" id="scAddBtn" onclick="addSelectedSuggestedContacts()" style="display:none">Add Selected (0)</button>
        </div>
    </div>
</div>


<!-- Send Quote Modal -->
<div id="sendQuoteModal" class="modal-bg" onclick="if(event.target===this)closeModal('sendQuoteModal')">
    <div class="modal" style="max-width:440px">
        <h3 class="u-mb-md">Send Quote</h3>
        <p id="sqQuoteNum" style="font-size:12px;color:var(--text2);margin-bottom:12px"></p>
        <label style="display:block;margin-bottom:8px;font-size:12px;font-weight:600">Recipient</label>
        <select id="sqContactSelect" onchange="onSqContactChange()" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:12px;margin-bottom:8px">
        </select>
        <div id="sqManualRow" style="display:none;margin-bottom:8px">
            <label style="display:block;font-size:11px;color:var(--text2);margin-bottom:2px">Email address</label>
            <input id="sqManualEmail" type="email" placeholder="name@company.com" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:12px">
        </div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
            <button type="button" class="btn btn-ghost" onclick="closeModal('sendQuoteModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="confirmSendQuote()">Send</button>
        </div>
    </div>
</div>

<!-- Edit Offer Modal -->
<div id="editOfferModal" class="modal-bg" onclick="if(event.target===this)closeModal('editOfferModal')">
    <div class="modal modal-lg">
        <h2>Edit Offer</h2>
        <div class="lo-form">
            <input type="hidden" id="eoOfferId">
            <div class="field field-full"><label>Vendor Name</label><input id="eoVendor"></div>
            <div class="field"><label>Qty Available</label><input id="eoQty" type="number"></div>
            <div class="field"><label>Unit Price ($)</label><input id="eoPrice" type="number" step="0.0001"></div>
            <div class="field"><label>Lead Time</label><input id="eoLead"></div>
            <div class="field"><label>Condition</label>
                <select id="eoCond" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--input);font-size:12px">
                    <option value="New">New</option><option value="Refurbished">Refurbished</option><option value="Used">Used</option>
                </select>
            </div>
            <div class="field"><label>Date Code</label><input id="eoDC"></div>
            <div class="field"><label>Firmware</label><input id="eoFirmware"></div>
            <div class="field"><label>Hardware Rev</label><input id="eoHardware"></div>
            <div class="field"><label>Packaging</label><input id="eoPackaging"></div>
            <div class="field"><label>MOQ</label><input id="eoMoq" type="number"></div>
            <div class="field field-full"><label>Notes</label><input id="eoNotes"></div>
            <div class="field"><label>Status</label>
                <select id="eoStatus" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--input);font-size:12px">
                    <option value="active">Active</option><option value="expired">Expired</option><option value="won">Won</option><option value="lost">Lost</option>
                </select>
            </div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('editOfferModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="updateOffer()">Save Changes</button>
        </div>
    </div>
</div>

<!-- OneDrive Browser Modal -->
<div id="oneDriveModal" class="modal-bg" onclick="if(event.target===this)closeModal('oneDriveModal')">
    <div class="modal modal-lg">
        <h2>Browse OneDrive</h2>
        <div id="odBreadcrumb" class="u-fs-xs u-color-muted u-mb-sm">
            <a onclick="browseOneDrive('')" class="u-cursor-pointer" style="color:var(--teal)">Root</a>
        </div>
        <div id="odFileList" style="max-height:400px;overflow-y:auto"><p class="empty">Loadingâ€¦</p></div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('oneDriveModal')">Close</button>
        </div>
    </div>
</div>

<!-- Buy Plan Modal -->
<div id="buyPlanModal" class="modal-bg" onclick="if(event.target===this)closeModal('buyPlanModal')">
    <div class="modal modal-lg">
        <h2>Mark Won &amp; Submit Buy Plan</h2>
        <p class="u-fs-xs u-color-muted u-mb-md">Select items and set the quantity to purchase from each vendor. This will be sent to management for approval.</p>
        <table class="tbl u-mb-md">
            <thead><tr><th style="width:30px"></th><th>MPN</th><th>Mfr</th><th>Avail Qty</th><th>Plan Qty</th><th>Unit Cost</th><th>Line Total</th><th>Lead</th></tr></thead>
            <tbody id="bpItems"></tbody>
        </table>
        <div style="text-align:right;font-weight:600;margin-bottom:12px">Total Cost: <span id="bpTotal"></span></div>
        <div class="field u-mb-md">
            <label>Notes for Manager &amp; Buyers</label>
            <textarea id="bpSalespersonNotes" rows="3" placeholder="Add any context, special instructions, or notes for the purchasing team..." style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--input)"></textarea>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('buyPlanModal')">Cancel</button>
            <button type="button" class="btn btn-success" onclick="submitBuyPlan()">Mark Won &amp; Submit Buy Plan</button>
        </div>
    </div>
</div>

<!-- Lost Reason Modal -->
<div id="lostModal" class="modal-bg" onclick="if(event.target===this)closeModal('lostModal')">
    <div class="modal">
        <h2>Mark Quote as Lost</h2>
        <div class="field">
            <label>Reason</label>
            <select id="lostReason" style="padding:8px 10px;border:1px solid var(--border);border-radius:6px;background:var(--input);font-size:12px">
                <option value="">â€” Select â€”</option>
                <option value="price">Price too high</option>
                <option value="lead_time">Lead time too long</option>
                <option value="competitor">Lost to competitor</option>
                <option value="no_response">No response</option>
                <option value="cancelled">Customer cancelled</option>
                <option value="other">Other</option>
            </select>
        </div>
        <div class="field"><label>Notes</label><input id="lostNotes" placeholder="Optional detailsâ€¦"></div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('lostModal')">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="submitLost()">Mark Lost</button>
        </div>
    </div>
</div>

<!-- Pricing History Modal -->
<div id="phModal" class="modal-bg" onclick="if(event.target===this)closeModal('phModal')">
    <div class="modal modal-lg">
        <h2>Pricing History â€” <span id="phMpn" style="font-family:'JetBrains Mono',monospace"></span></h2>
        <div id="phContent"><p class="empty">Loadingâ€¦</p></div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('phModal')">Close</button>
        </div>
    </div>
</div>

<!-- Site Contact Modal -->
<div id="siteContactModal" class="modal-bg" onclick="if(event.target===this)closeModal('siteContactModal')">
    <div class="modal">
        <h2 id="siteContactModalTitle">Add Contact</h2>
        <input type="hidden" id="scSiteId">
        <input type="hidden" id="scContactId">
        <div class="lo-form">
            <div class="field"><label for="scFullName">Name *</label><input id="scFullName" placeholder="Full name" required onkeydown="if(event.key==='Enter')saveSiteContact()"></div>
            <div class="field"><label for="scTitle">Job Title</label><input id="scTitle" placeholder="e.g. Purchasing Manager"></div>
            <div class="field"><label for="scEmail">Email</label><input id="scEmail" type="email" placeholder="email@company.com"></div>
            <div class="field"><label for="scPhone">Phone</label><input id="scPhone" type="tel" placeholder="+1 555-000-0000"></div>
            <div class="field field-full"><label for="scNotes">Notes</label><textarea id="scNotes" rows="2" placeholder="Optional notes"></textarea></div>
        </div>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0;font-size:12px;color:var(--text2);cursor:pointer"><input id="scPrimary" type="checkbox" class="u-accent-teal" aria-label="Primary contact"> Primary contact</label>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('siteContactModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveSiteContact()">Save Contact</button>
        </div>
    </div>
</div>

<!-- Log Call Modal -->
<div id="logCallModal" class="modal-bg" onclick="if(event.target===this)closeModal('logCallModal')">
    <div class="modal">
        <h2>Log Phone Call &mdash; <span id="lcCompanyName"></span></h2>
        <input type="hidden" id="lcCompanyId">
        <div class="lo-form">
            <div class="field"><label for="lcPhone">Phone *</label><input id="lcPhone" type="tel" placeholder="+1 555-000-0000" required onkeydown="if(event.key==='Enter')saveLogCall()"></div>
            <div class="field"><label for="lcContactName">Contact Name</label><input id="lcContactName" placeholder="Who did you speak to?"></div>
            <div class="field"><label for="lcDirection">Direction</label>
                <select id="lcDirection" style="background:var(--input);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;width:100%">
                    <option value="outbound">Outbound</option>
                    <option value="inbound">Inbound</option>
                </select>
            </div>
            <div class="field"><label for="lcDuration">Duration (seconds)</label><input id="lcDuration" type="number" placeholder="120" min="0"></div>
            <div class="field"><label for="lcNotes">Notes</label><textarea id="lcNotes" rows="3" placeholder="Call summary..." style="width:100%;background:var(--input);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;resize:vertical"></textarea></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('logCallModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveLogCall()">Log Call</button>
        </div>
    </div>
</div>

<div id="logNoteModal" class="modal-bg" onclick="if(event.target===this)closeModal('logNoteModal')">
    <div class="modal">
        <h2>Add Note &mdash; <span id="lnCompanyName"></span></h2>
        <input type="hidden" id="lnCompanyId">
        <div class="lo-form">
            <div class="field"><label for="lnContactName">Contact Name (optional)</label><input id="lnContactName" placeholder="Related contact name"></div>
            <div class="field"><label for="lnNotes">Note *</label><textarea id="lnNotes" rows="4" placeholder="Enter note..." required style="width:100%;background:var(--input);border:1px solid var(--border);border-radius:6px;padding:8px 10px;font-size:12px;resize:vertical"></textarea></div>
        </div>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('logNoteModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveLogNote()">Save Note</button>
        </div>
    </div>
</div>

<!-- Compare Offers Modal -->

<!-- Proactive Send Modal -->
<div id="proactiveSendModal" class="modal-bg" onclick="if(event.target===this)closeModal('proactiveSendModal')">
    <div class="modal" style="max-width:680px">
        <h2>Send Proactive Offer</h2>
        <p id="psmCustomer" style="font-size:13px;color:var(--text2);margin-bottom:12px"></p>

        <div class="u-mb-md">
            <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block">Selected Items</label>
            <table class="offer-table" style="width:100%;font-size:12px">
                <thead><tr><th>MPN</th><th>Vendor</th><th>Qty</th><th>Cost</th><th>Sell Price</th><th>Condition</th></tr></thead>
                <tbody id="psmItems"></tbody>
            </table>
        </div>

        <div class="send-preview" id="psmPreview"></div>

        <div class="u-mt-md">
            <label style="font-size:12px;font-weight:600;margin-bottom:4px;display:block">Contacts</label>
            <div id="psmContacts" style="font-size:12px"><span class="empty">Loading contactsâ€¦</span></div>
        </div>

        <div class="field u-mt-md">
            <label for="psmSubject">Subject</label>
            <input id="psmSubject" placeholder="Parts Available â€” Company">
        </div>

        <div class="field" style="margin-top:8px">
            <label for="psmNotes">Notes (optional)</label>
            <textarea id="psmNotes" rows="3" placeholder="Add a personal messageâ€¦" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px;resize:vertical"></textarea>
        </div>

        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('proactiveSendModal')">Cancel</button>
            <button type="button" class="btn btn-primary" id="psmSendBtn" onclick="sendProactiveOffer()">Send Email</button>
        </div>
    </div>
</div>

    <!-- VIEW: Performance Tracking -->
    <div id="view-performance" style="display:none">
        <div class="view-toolbar">
            <h2>Scorecards</h2>
        </div>
        <div class="fpills" id="perfTabs" style="margin:0 16px 12px">
            <button type="button" class="fp on" onclick="switchPerfTab('vendors',this)">Vendor Scorecard</button>
            <button type="button" class="fp" onclick="switchPerfTab('buyers',this)">Buyer Leaderboard</button>
            <button type="button" class="fp" onclick="switchPerfTab('sales',this)">Salesperson Scorecard</button>
            <button type="button" class="fp" id="perfDigestTab" onclick="switchPerfTab('digest',this)" style="display:none">Team Digest</button>
        </div>
        <div id="perfVendorPanel"><p class="empty">Loading...</p></div>
        <div id="perfBuyerPanel" style="display:none"><p class="empty">Loading...</p></div>
        <div id="perfSalesPanel" style="display:none"><p class="empty">Loading...</p></div>
        <div id="perfDigestPanel" style="display:none"><p class="empty">Loading...</p></div>
    </div>


    <!-- VIEW: Settings (admin + dev_assistant) -->
    <div id="view-settings" style="display:none">
        <div class="vendor-header">
            <h2>Admin Settings</h2>
        </div>
        <div class="tabs" id="settingsTabs">
            <button type="button" class="tab on settings-tab-users" onclick="switchSettingsTab('users',this)">Users</button>
            <button type="button" class="tab" onclick="switchSettingsTab('health',this)">System Health</button>
            <button type="button" class="tab settings-tab-scoring" onclick="switchSettingsTab('scoring',this)">Scoring Weights</button>
            <button type="button" class="tab" onclick="switchSettingsTab('config',this)">Configuration</button>
            <button type="button" class="tab" onclick="switchSettingsTab('sources',this)">Data Sources</button>
            <button type="button" class="tab settings-tab-users" onclick="switchSettingsTab('create-user',this)">Create User</button>
            <button type="button" class="tab" onclick="switchSettingsTab('enrichment',this)">Enrichment</button>
            <button type="button" class="tab settings-tab-users" onclick="switchSettingsTab('unmatched',this)">Unmatched Queue</button>
            <button type="button" class="tab settings-tab-users" onclick="switchSettingsTab('teams',this)">Teams Integration</button>
            <button type="button" class="tab settings-tab-users" onclick="switchSettingsTab('import',this)">Import</button>
            <button type="button" class="tab settings-tab-users" onclick="switchSettingsTab('tickets',this)">Trouble Tickets</button>
        </div>

        <div id="settings-users" class="settings-panel">
            <div id="adminUsersList"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-health" class="settings-panel" style="display:none">
            <div id="settingsHealthContent"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-scoring" class="settings-panel" style="display:none">
            <div id="settingsScoringContent"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-config" class="settings-panel" style="display:none">
            <div id="settingsConfigContent"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-sources" class="settings-panel" style="display:none">
            <div id="settingsSourcesList"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-unmatched" class="settings-panel" style="display:none">
            <div id="unmatchedQueueContent"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-teams" class="settings-panel" style="display:none">
            <div id="teamsConfigContent"><p class="empty">Loading...</p></div>
        </div>

        <div id="settings-import" class="settings-panel" style="display:none">
            <div class="card s-card">
                <h3>Import Customers</h3>
                <p class="s-desc">CSV: company_name, site_name, contact_name, contact_email, contact_phone</p>
                <div class="s-form">
                    <input type="file" id="customerImportFile" accept=".csv">
                    <div><button type="button" class="btn btn-primary btn-sm" onclick="importCustomers()">Import</button></div>
                    <div id="customerImportStatus" class="s-status"></div>
                </div>
            </div>
            <div class="card s-card">
                <h3>Import Vendors</h3>
                <p class="s-desc">CSV: vendor_name, domain, website, contact_name, contact_email</p>
                <div class="s-form">
                    <input type="file" id="vendorImportFile" accept=".csv">
                    <div><button type="button" class="btn btn-primary btn-sm" onclick="importVendors()">Import</button></div>
                    <div id="vendorImportStatus" class="s-status"></div>
                </div>
            </div>
        </div>

        <div id="settings-enrichment" class="settings-panel" style="display:none">
            <div class="tabs" id="enrichTabs">
                <button type="button" class="tab on" onclick="switchEnrichTab('queue',this)">Review Queue</button>
                <button type="button" class="tab" onclick="switchEnrichTab('backfill',this)">Backfill</button>
                <button type="button" class="tab" onclick="switchEnrichTab('jobs',this)">Job History</button>
                <button type="button" class="tab" onclick="switchEnrichTab('m365',this)">Inbox Mining</button>
            </div>

            <!-- Review Queue Tab -->
            <div id="enrichQueuePanel">
                <div class="s-row" style="gap:8px;margin-bottom:12px;flex-wrap:wrap">
                    <select id="eqStatusFilter" onchange="loadEnrichmentQueue()" class="s-select" style="padding:6px 10px">
                        <option value="pending">Pending</option>
                        <option value="auto_applied">Auto-Applied</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="all">All</option>
                    </select>
                    <select id="eqEntityFilter" onchange="loadEnrichmentQueue()" class="s-select" style="padding:6px 10px">
                        <option value="">All Entities</option>
                        <option value="vendor">Vendors</option>
                        <option value="company">Companies</option>
                    </select>
                    <button type="button" class="btn btn-sm" onclick="bulkApproveSelected()" id="eqBulkApproveBtn" style="display:none">Approve Selected</button>
                    <span id="eqCount" class="s-hint u-ml-auto"></span>
                </div>
                <div id="enrichQueueList"><p class="empty">Loading...</p></div>
            </div>

            <!-- Backfill Tab -->
            <div id="enrichBackfillPanel" style="display:none">
                <div class="card s-card">
                    <h3>Start Deep Enrichment</h3>
                    <div class="s-form">
                        <label><input type="checkbox" id="bfVendors" checked> Vendors</label>
                        <label><input type="checkbox" id="bfCompanies" checked> Companies</label>
                        <label><input type="checkbox" id="bfDeepEmail"> Include Deep Email Mining</label>
                        <label class="s-row">Max items: <input type="number" id="bfMaxItems" value="500" min="1" max="2000" class="s-input-num"></label>
                        <div class="s-row"><button type="button" class="btn" onclick="startBackfill()">Start Enrichment</button> <span id="bfStatus" class="s-hint"></span></div>
                    </div>
                </div>
                <div id="bfProgressBox" class="s-card" style="display:none">
                    <h4 style="margin:0 0 12px">Running Job</h4>
                    <div style="background:var(--bg);border-radius:4px;height:20px;overflow:hidden;margin-bottom:8px">
                        <div id="bfProgressBar" style="height:100%;background:var(--teal);transition:width 0.3s;width:0%"></div>
                    </div>
                    <span id="bfProgressLabel" class="s-hint"></span>
                </div>

                <div class="card s-card">
                    <h3>Backfill from Existing Data</h3>
                    <p class="s-desc">Recover vendor emails already in the system â€” activity logs, vendor card imports, and BrokerBin sightings.</p>
                    <div class="s-row"><button type="button" class="btn" onclick="startEmailBackfill()">Backfill Emails</button> <span id="emailBfStatus" class="s-hint"></span></div>
                </div>

                <div class="card s-card">
                    <h3>Scrape Vendor Websites</h3>
                    <p class="s-desc">Scrape contact pages of vendors with websites but few email contacts.</p>
                    <div class="s-form">
                        <label class="s-row">Max vendors: <input type="number" id="scrapeMaxVendors" value="500" min="1" max="2000" class="s-input-num"></label>
                        <div class="s-row"><button type="button" class="btn" onclick="startWebsiteScrape()">Scrape Websites</button> <span id="scrapeStatus" class="s-hint"></span></div>
                    </div>
                </div>
            </div>

            <!-- Job History Tab -->
            <div id="enrichJobsPanel" style="display:none">
                <div id="enrichJobsList"><p class="empty">Loading...</p></div>
            </div>

            <!-- M365 Connection Status -->
            <div id="enrichM365Panel" style="display:none">
                <div class="card s-card">
                    <h3>M365 Inbox Mining</h3>
                    <p class="s-desc">Users must authenticate via Azure AD to enable inbox mining for vendor email extraction.</p>
                    <div id="m365UserList"><p class="empty">Loading...</p></div>
                </div>
            </div>

            <!-- Stats Summary -->
            <div id="enrichStatsPanel" style="margin-top:16px;padding:12px 16px;background:var(--bg);border-radius:8px;border:1px solid var(--border);display:flex;gap:24px;flex-wrap:wrap">
                <div><strong id="esVendors">-</strong><br><small class="s-hint">Vendors Enriched</small></div>
                <div><strong id="esCompanies">-</strong><br><small class="s-hint">Companies Enriched</small></div>
                <div><strong id="esPending">-</strong><br><small class="s-hint">Pending Review</small></div>
                <div><strong id="esAutoApplied">-</strong><br><small class="s-hint">Auto-Applied</small></div>
                <div><strong id="esActiveJobs">-</strong><br><small class="s-hint">Active Jobs</small></div>
                <div><strong id="esVendorEmails">-</strong><br><small class="s-hint">Vendor Emails</small></div>
            </div>
        </div>

        <div id="settings-tickets" class="settings-panel" style="display:none">
            <div class="s-row" style="gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center">
                <select id="ticketStatusFilter" onchange="loadTroubleTickets()" class="s-select" style="padding:6px 10px">
                    <option value="">All</option>
                    <option value="open" selected>Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                    <option value="closed">Closed</option>
                </select>
                <button type="button" class="btn btn-sm" onclick="exportTicketsXlsx()">Export Excel</button>
                <span id="ticketCount" class="s-hint u-ml-auto"></span>
            </div>
            <div id="ticketList"><p class="empty">Loading...</p></div>
            <div id="ticketDetail" style="display:none"></div>
        </div>

        <div id="settings-create-user" class="settings-panel" style="display:none">
            <div class="card s-card">
                <h3>Create New User</h3>
                <div class="s-form">
                    <input id="newUserName" class="s-input" placeholder="Full name">
                    <input id="newUserEmail" class="s-input" placeholder="Email address" type="email">
                    <select id="newUserRole" class="s-select">
                        <option value="buyer">Buyer</option>
                        <option value="trader">Trader</option>
                        <option value="sales">Sales</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                        <option value="dev_assistant">Dev Assistant</option>
                    </select>
                    <div><button type="button" class="btn btn-primary" onclick="createUser()">Create User</button></div>
                </div>
            </div>
        </div>

    </div><!-- end view-settings -->
    </div><!-- end main-scroll -->
</main><!-- end main -->

<!-- Bug Report Modal -->
<div id="bugReportModal" class="modal-bg" onclick="if(event.target===this)closeModal('bugReportModal')">
    <div class="modal" style="max-width:520px">
        <h2>Report a Bug</h2>
        <div class="field"><label for="bugTitle">Title <span style="color:var(--red)">*</span></label><input id="bugTitle" placeholder="Brief description of the issue" maxlength="255"></div>
        <div class="field" style="margin-top:10px"><label for="bugDescription">Details</label><textarea id="bugDescription" rows="4" placeholder="Steps to reproduce, what you expected vs what happenedâ€¦" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;resize:vertical;font-family:inherit"></textarea></div>
        <div class="field" style="margin-top:10px">
            <label>Screenshot <span style="color:var(--muted);font-weight:400;font-size:11px">(paste or drag image)</span></label>
            <div class="bug-drop-zone" id="bugDropZone"
                 ondragover="event.preventDefault();this.classList.add('drag-over')"
                 ondragleave="this.classList.remove('drag-over')"
                 ondrop="event.preventDefault();this.classList.remove('drag-over');_handleBugScreenshot((event.dataTransfer.files||[])[0])">
                <span class="bug-drop-text">Drop image here or Ctrl+V to paste</span>
                <img id="bugScreenshotPreview" style="display:none;max-width:100%;max-height:200px;border-radius:4px;margin-top:8px">
                <a onclick="clearBugScreenshot()" class="bug-clear-screenshot" style="display:none">Remove</a>
            </div>
        </div>
        <p style="font-size:11px;color:var(--muted);margin-top:8px">Browser info, URL, and console errors are captured automatically.</p>
        <div class="mactions">
            <button type="button" class="btn btn-ghost" onclick="closeModal('bugReportModal')">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitBugReport(this)">Submit Report</button>
        </div>
    </div>
</div>

<script type="application/json" id="app-config">{"userName":"{{ user_name }}","userEmail":"{{ user_email }}","isAdmin":{{ "true" if is_admin else "false" }},"isDevAssistant":{{ "true" if is_dev_assistant else "false" }}}</script>
<script defer src="/static/app.js?v={{ app_version }}"></script>
<script defer src="/static/crm.js?v={{ app_version }}"></script>
{% endif %}
</body>
</html>
